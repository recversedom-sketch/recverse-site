---
import BaseLayout from "../layouts/BaseLayout.astro";

const sp = Astro.url.searchParams;
const preTopic = sp.get("topic") ?? "";
const preModule = sp.get("module") ?? "";
const prePackage = sp.get("package") ?? "";
const preBudget = sp.get("budget") ?? "";
const preTimeline = sp.get("timeline") ?? "";

const prefill =
  prePackage ? `Paket: ${prePackage}\n` :
  preModule ? `Modul: ${preModule}\n` :
  preTopic ? `Thema: ${preTopic}\n` : "";

const topics = [
  "KI-MVP / PoC",
  "Transformation / Projektmanagement",
  "Website (Landing/Blog/Business)",
  "Prozess-/Unternehmensberatung",
  "IT-Projektmanagement",
  "Etwas anderes",
];

const budgets = [
  "unter CHF 500",
  "CHF 500-1'500",
  "CHF 1'500-5'000",
  "CHF 5'000+",
  "noch offen",
];

const timelines = [
  "sofort / diese Woche",
  "2-4 Wochen",
  "1-3 Monate",
  "spaeter",
];
---

<BaseLayout title="Angebot anfragen - RecVerse" description="Anfrage fuer KI-MVP, Transformation-PM oder Beratung.">
  <section class="mx-auto max-w-3xl px-4 py-16">
    <h1 class="text-3xl font-semibold">Angebot anfragen</h1>
    <p class="mt-3 text-zinc-300">
      Kurz beschreiben, was du erreichen willst. Du bekommst eine konkrete Rueckmeldung (Scope, Timeline, Budgetrahmen).
    </p>

    <form
      name="angebot"
      method="POST"
      action="/thanks/"
      data-netlify="true"
      data-netlify-honeypot="bot-field"
      class="mt-8 space-y-4 rc-card p-8"
    >
      <!-- Pflicht fuer Netlify Forms -->
      <input type="hidden" name="form-name" value="angebot" />

      <!-- Honeypot 1 (Netlify) -->
      <p class="hidden">
        <label>Don’t fill this out: <input name="bot-field" autocomplete="off" /></label>
      </p>

      <!-- Honeypot 2 (zusatz) -->
      <p class="hidden">
        <label>Leave empty: <input name="nickname" autocomplete="off" /></label>
      </p>

      <!-- Time-trap -->
      <input type="hidden" name="ts" id="ts" value="" />

      <div class="grid gap-4 md:grid-cols-2">
        <label class="space-y-2">
          <span class="text-sm text-zinc-300">Name</span>
          <input
            name="name"
            required
            autocomplete="name"
            class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-4 py-3 text-zinc-100"
          />
        </label>

        <label class="space-y-2">
          <span class="text-sm text-zinc-300">E-Mail</span>
          <input
            name="email"
            type="email"
            required
            autocomplete="email"
            inputmode="email"
            class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-4 py-3 text-zinc-100"
          />
        </label>

        <label class="space-y-2 block">
          <span class="text-sm text-zinc-300">Firma / Organisation (optional)</span>
          <input
            name="org"
            autocomplete="organization"
            class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-4 py-3 text-zinc-100"
         />
        </label>
      </div>

      <div class="grid gap-4 md:grid-cols-2">
        <label class="space-y-2">
          <span class="text-sm text-zinc-300">Telefon (optional)</span>
          <input
            name="phone"
            type="tel"
            autocomplete="tel"
            inputmode="tel"
            placeholder="+41 …"
            class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-4 py-3 text-zinc-100"
          />
        </label>

        <label class="space-y-2">
          <span class="text-sm text-zinc-300">Rolle (optional)</span>
          <select
            name="role"
            class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-4 py-3 text-zinc-100"
          >
            <option value="">bitte waehlen</option>
            <option>Inhaber / Geschaeftsfuehrung</option>
            <option>Projektleitung / PM</option>
            <option>IT / Engineering</option>
            <option>Fachbereich / Business</option>
            <option>Privatperson</option>
          </select>
        </label>
      </div>

      <label class="space-y-2 block">
        <span class="text-sm text-zinc-300">Worum geht’s?</span>
        <select
          name="topic"
          class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-4 py-3 text-zinc-100"
        >
          {topics.map((opt) => (
            <option value={opt} selected={preTopic === opt}>{opt}</option>
          ))}
        </select>
      </label>

      <div class="grid gap-4 md:grid-cols-2">
        <label class="space-y-2">
          <span class="text-sm text-zinc-300">Budgetrahmen</span>
          <select
            name="budget"
            class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-4 py-3 text-zinc-100"
          >
            {budgets.map((b) => (
              <option value={b} selected={preBudget === b}>{b}</option>
            ))}
          </select>
        </label>

        <label class="space-y-2">
          <span class="text-sm text-zinc-300">Zeitrahmen</span>
          <select
            name="timeline"
            class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-4 py-3 text-zinc-100"
          >
            {timelines.map((t) => (
              <option value={t} selected={preTimeline === t}>{t}</option>
            ))}
          </select>
        </label>
      </div>
      
      <label class="space-y-2 block">
        <span class="text-sm text-zinc-300">Aktueller Stand (pflicht)</span>
        <textarea
          name="current_state"
          required
          rows="4"
          class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-4 py-3 text-zinc-100"
          placeholder="Was existiert bereits? (z.B. Idee, Konzept, aktuelle Website, Tools/ERP, Team, Constraints, offene Fragen)"
        ></textarea>
      </label>
      
      <label class="space-y-2 block">
        <span class="text-sm text-zinc-300">Kurzbeschreibung</span>
        <textarea
          name="message"
          required
          rows="7"
          class="w-full rounded-xl border border-zinc-700 bg-zinc-950 px-4 py-3 text-zinc-100"
        >{prefill}</textarea>
        <p class="text-xs text-zinc-500">
          Tipp: Ziel, aktueller Stand, gewuenschter Output, Stakeholder, technische Randbedingungen.
        </p>
      </label>

      <!-- Soft-block gegen typische Spam-/SEO-/LinkedIn-Pitches -->
      <label class="mt-2 flex items-start gap-3 text-sm text-zinc-300">
        <input
          id="noPitch"
          name="noPitch_confirm"
          type="checkbox"
          required
          class="mt-1 h-4 w-4 rounded border border-zinc-700 bg-zinc-950"
        />
        <span>
          Ich kontaktiere dich <strong>nicht</strong> wegen SEO/Backlinks/Guest-Posts/Leadgen/Recruiting/LinkedIn-Outreach,
          sondern weil ich eine konkrete Leistung anfragen will.
        </span>
      </label>

      <button
        id="submitBtn"
        <button type="submit" class="rc-btn rc-btn-primary">
  Anfrage senden
</button>


      <p class="text-xs text-zinc-500">
        Mit dem Absenden erklaerst du dich mit der Verarbeitung deiner Angaben zur Bearbeitung deiner Anfrage einverstanden.
        Details siehe <a class="underline" href="/privacy">Datenschutz</a>.
      </p>

      <script is:inline>
        (function () {
          const form = document.currentScript?.closest("form");
          if (!form) return;

          const tsEl = form.querySelector("#ts");
          const btn = form.querySelector("#submitBtn");
          const bot1 = form.querySelector('input[name="bot-field"]');
          const bot2 = form.querySelector('input[name="nickname"]');
          const emailEl = form.querySelector('input[name="email"]');
          const msgEl = form.querySelector('textarea[name="message"]');

          // set timestamp when page loads
          if (tsEl) tsEl.value = String(Date.now());

          // simple keyword filter for obvious pitches (soft-block)
          const blockedPatterns = [
            "seo", "backlink", "guest post", "linkbuilding", "link building",
            "outreach", "ranking", "traffic guarantee", "google first page",
            "linkedin", "recruit", "headhunt", "leadgen", "lead generation",
          ];

          function includesBlocked(text) {
            const t = (text || "").toLowerCase();
            return blockedPatterns.some(p => t.includes(p));
          }

          form.addEventListener("submit", (e) => {
            // Honeypots must be empty
            if ((bot1 && bot1.value.trim()) || (bot2 && bot2.value.trim())) {
              e.preventDefault();
              return;
            }

            // Time-trap: minimum time on page before submit
            const started = Number(tsEl?.value || "0");
            const minMs = 4000; // 4 seconds
            if (!started || (Date.now() - started) < minMs) {
              e.preventDefault();
              alert("Bitte kurz pruefen und nach wenigen Sekunden erneut absenden.");
              return;
            }

            // Soft-block spam keywords
            const email = emailEl?.value || "";
            const msg = msgEl?.value || "";
            if (includesBlocked(email) || includesBlocked(msg)) {
              e.preventDefault();
              alert("Bitte nur konkrete Leistungsanfragen senden (keine SEO/Outreach/Recruiting-Pitches).");
              return;
            }

            // Double-submit protection
            if (btn) {
              btn.setAttribute("disabled", "disabled");
              btn.textContent = "Wird gesendet…";
            }
          });
        })();
      </script>
    </form>
  </section>
</BaseLayout>
