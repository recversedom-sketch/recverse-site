---
import BaseLayout from "../layouts/BaseLayout.astro";

const sp = Astro.url.searchParams;
const preTopic = sp.get("topic") ?? "";
const preModule = sp.get("module") ?? "";
const prePackage = sp.get("package") ?? "";

const prefill =
  prePackage ? `Paket: ${prePackage}\n` :
  preModule ? `Modul: ${preModule}\n` :
  preTopic ? `Thema: ${preTopic}\n` : "";
---

<BaseLayout
  title="Kontakt — Recverse"
  description="Kontaktformular für Angebote: Websites, KI-MVPs, Transformation/IT-Projektmanagement."
>
  <section class="section">
    <div class="container">
      <div class="kicker">
        <span class="kicker__dot" aria-hidden="true"></span>
        <span>Kontakt</span>
      </div>

      <h1 class="h1">Angebot anfragen</h1>
      <p class="lead">
        Kurz beschreiben, was du erreichen willst. Du bekommst eine konkrete Rückmeldung (Scope, nächste Schritte).
      </p>

      <form
        class="form"
        name="angebot"
        method="POST"
        action="/thanks/"
        data-netlify="true"
        data-netlify-honeypot="bot-field"
        data-form
      >
        <input type="hidden" name="form-name" value="angebot" />

        <!-- Honeypot (soll leer bleiben) -->
        <p class="sr-only">
          <label>Don’t fill this out: <input name="bot-field" /></label>
        </p>

        <!-- Time-trap -->
        <input type="hidden" name="tt_start" value="" data-tt-start />
        <input type="hidden" name="tt_ms" value="" data-tt-ms />

        <div class="row row--2">
          <label class="field">
            <span class="field__label">Name *</span>
            <input class="input" name="name" required autocomplete="name" />
          </label>

          <label class="field">
            <span class="field__label">E-Mail *</span>
            <input class="input" name="email" type="email" required autocomplete="email" />
          </label>
        </div>

        <div class="row row--2">
          <label class="field">
            <span class="field__label">Firma (optional)</span>
            <input class="input" name="company" autocomplete="organization" />
          </label>

          <label class="field">
            <span class="field__label">Telefon (optional)</span>
            <input class="input" name="phone" autocomplete="tel" />
          </label>
        </div>

        <label class="field">
          <span class="field__label">Worum geht’s?</span>
          <select class="select" name="topic">
            {[
              "Website (Landing/Blog/Business)",
              "KI-MVP / PoC",
              "Transformation & Delivery PM",
              "IT-Projektmanagement",
              "Etwas anderes",
            ].map((opt) => (
              <option value={opt} selected={preTopic === opt}>{opt}</option>
            ))}
          </select>
        </label>

        <label class="field">
          <span class="field__label">Kurzbeschreibung *</span>
          <textarea class="textarea" name="message" required rows="7">{prefill}</textarea>
        </label>

        <div class="row row--2">
          <label class="field">
            <span class="field__label">Budgetrahmen</span>
            <select class="select" name="budget">
              <option>unter CHF 500</option>
              <option>CHF 500–1'500</option>
              <option>CHF 1'500–5'000</option>
              <option>CHF 5'000+</option>
              <option>noch offen</option>
            </select>
          </label>

          <label class="field">
            <span class="field__label">Zeitrahmen</span>
            <select class="select" name="timeline">
              <option>sofort / diese Woche</option>
              <option>2–4 Wochen</option>
              <option>1–3 Monate</option>
              <option>später</option>
            </select>
          </label>
        </div>

        <!-- Bot-Falle: "Website" ist für echte Menschen irrelevant -->
        <label class="field sr-only">
          <span class="field__label">Website</span>
          <input class="input" name="website" tabindex="-1" autocomplete="off" />
        </label>

        <div class="hero__actions">
          <button class="btn btn--primary" type="submit">Anfrage senden</button>
          <a class="btn btn--ghost" href="/privacy">Datenschutz</a>
        </div>

        <p class="help" data-tt-hint>
          Mit dem Absenden erklärst du dich mit der Verarbeitung deiner Angaben zur Bearbeitung deiner Anfrage einverstanden.
          Details siehe <a href="/privacy">Datenschutz</a>.
        </p>

        <p class="help" data-tt-error style="display:none">
          Bitte warte einen Moment und sende dann nochmals ab. (Anti-Spam Schutz)
        </p>
      </form>

      <script is:inline>
        (() => {
          const form = document.querySelector("[data-form]");
          if (!form) return;

          const startEl = form.querySelector("[data-tt-start]");
          const msEl = form.querySelector("[data-tt-ms]");
          const err = form.querySelector("[data-tt-error]");
          const hint = form.querySelector("[data-tt-hint]");

          const started = Date.now();
          if (startEl) startEl.value = String(started);

          form.addEventListener("submit", (e) => {
            const ms = Date.now() - started;
            if (msEl) msEl.value = String(ms);

            // Time-trap: < 3s gilt als sehr wahrscheinlich Bot/Script
            if (ms < 3000) {
              e.preventDefault();
              if (err) err.style.display = "block";
              if (hint) hint.style.display = "none";
              return false;
            }
          });
        })();
      </script>
    </div>
  </section>
</BaseLayout>
