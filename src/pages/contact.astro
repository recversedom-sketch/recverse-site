---
import BaseLayout from "../layouts/BaseLayout.astro";

const sp = Astro.url.searchParams;
const preTopic = sp.get("topic") ?? "";
const preModule = sp.get("module") ?? "";
const prePackage = sp.get("package") ?? "";

const prefill =
  prePackage ? `Paket: ${prePackage}\n` :
  preModule ? `Modul: ${preModule}\n` :
  preTopic ? `Thema: ${preTopic}\n` : "";
---

<BaseLayout
  title="Kontakt — Recverse"
  description="Kontaktformular für Projekte (Web, KI, Transformation/PM). Kurzer Input, konkrete Rückmeldung."
>
  <section class="container" style="padding-top: 34px; padding-bottom: 62px;">
    <div class="top card">
      <div class="pill"><span class="dot"></span> Kurz, konkret, verwertbar</div>

      <div class="top-grid">
        <div>
          <h1 style="margin-top:14px; font-family:'Space Grotesk', Inter, system-ui;">
            Projekt anfragen
          </h1>
          <p style="margin-top:14px; max-width: 70ch;">
            Schreib kurz, was du erreichen willst. Ich antworte konkret: Scope-Vorschlag, nächste Schritte.
          </p>

          <div class="meta">
            <div class="meta-item">
              <strong>Antwortstil</strong>
              <span>direkt, sachlich, ohne Sales-Floskeln</span>
            </div>
            <div class="meta-item">
              <strong>Typische Themen</strong>
              <span>Web, KI-MVP/PoC, Transformation, IT-PM</span>
            </div>
          </div>
        </div>

        <form
          name="angebot"
          method="POST"
          action="/thanks/"
          data-netlify="true"
          data-netlify-honeypot="bot-field"
          class="form card"
          id="contactForm"
        >
          <input type="hidden" name="form-name" value="angebot" />

          <!-- Honeypot (Netlify) -->
          <p class="hidden">
            <label>Don’t fill this out: <input name="bot-field" /></label>
          </p>

          <!-- Time-trap fields -->
          <input type="hidden" name="tt_start" id="tt_start" value="" />
          <input type="hidden" name="tt_elapsed_ms" id="tt_elapsed_ms" value="" />

          <!-- Prefill signals (optional) -->
          <input type="hidden" name="pref_topic" value={preTopic} />
          <input type="hidden" name="pref_module" value={preModule} />
          <input type="hidden" name="pref_package" value={prePackage} />

          <div class="grid2">
            <label class="field">
              <span>Name</span>
              <input name="name" required autocomplete="name" />
            </label>

            <label class="field">
              <span>E-Mail</span>
              <input name="email" type="email" required autocomplete="email" />
            </label>
          </div>

          <label class="field">
            <span>Worum geht’s?</span>
            <select name="topic">
              {[
                "Website (Landing/Blog/Business)",
                "Website (Datenschutz-Check)",
                "Website (Performance/UX)",
                "KI-MVP / PoC",
                "Prozess-/Unternehmensberatung",
                "IT-Projektmanagement",
                "RecVerseShop",
                "Etwas anderes",
              ].map((opt) => (
                <option value={opt} selected={preTopic === opt}>{opt}</option>
              ))}
            </select>
          </label>

          <label class="field">
            <span>Kurzbeschreibung</span>
            <textarea name="message" required rows="7">{prefill}</textarea>
            <small>Optional: Ziel, Ausgangslage, Deadline, Constraints.</small>
          </label>

          <div class="grid2">
            <label class="field">
              <span>Budgetrahmen (optional)</span>
              <select name="budget">
                <option>noch offen</option>
                <option>unter CHF 500</option>
                <option>CHF 500-1'500</option>
                <option>CHF 1'500-5'000</option>
                <option>CHF 5'000+</option>
              </select>
            </label>

            <label class="field">
              <span>Zeitrahmen (optional)</span>
              <select name="timeline">
                <option>noch offen</option>
                <option>sofort / diese Woche</option>
                <option>2-4 Wochen</option>
                <option>1-3 Monate</option>
                <option>später</option>
              </select>
            </label>
          </div>

          <label class="consent">
            <input type="checkbox" name="consent" required />
            <span>
              Ich bin einverstanden, dass meine Angaben zur Bearbeitung der Anfrage verarbeitet werden.
              Details: <a href="/privacy">Datenschutz</a>.
            </span>
          </label>

          <div class="err" id="formError" role="status" aria-live="polite"></div>

          <button type="submit" class="btn primary">Anfrage senden</button>

          <p class="fine">
            Kein Newsletter. Keine Weitergabe an Dritte. Nur Bearbeitung deiner Anfrage.
          </p>
        </form>
      </div>
    </div>
  </section>

  <script is:inline>
    (function(){
      var form = document.getElementById("contactForm");
      if (!form) return;

      var startEl = document.getElementById("tt_start");
      var elapsedEl = document.getElementById("tt_elapsed_ms");
      var err = document.getElementById("formError");

      // Start timestamp on page load
      var started = Date.now();
      if (startEl) startEl.value = String(started);

      form.addEventListener("submit", function(e){
        var now = Date.now();
        var elapsed = now - started;
        if (elapsedEl) elapsedEl.value = String(elapsed);

        // Time-trap: block ultra-fast submits (typical bot behavior)
        // Threshold deliberately conservative to avoid false positives.
        if (elapsed < 2500) {
          e.preventDefault();
          if (err) {
            err.textContent = "Bitte kurz warten und dann erneut senden (Anti-Spam Schutz).";
          }
          return false;
        }

        // Clear error if ok
        if (err) err.textContent = "";
      });
    })();
  </script>

  <style>
    .top{ padding: 22px; border-radius: var(--r-2xl); }
    .top-grid{ display:grid; gap:18px; margin-top: 14px; }

    .meta{ display:grid; gap:10px; margin-top: 16px; }
    .meta-item{
      padding: 14px;
      border-radius: var(--r-xl);
      border: 1px solid rgb(var(--border) / .25);
      background: rgb(var(--surface) / .18);
    }
    .meta-item strong{ display:block; color: rgb(var(--text)); font-weight: 820; font-size: 13px; }
    .meta-item span{ display:block; margin-top:6px; color: rgb(var(--muted)); font-size: 12px; line-height: 1.6; }

    .form{ padding: 18px; border-radius: var(--r-2xl); }
    .grid2{ display:grid; gap: 12px; }

    .field{ display:grid; gap: 8px; }
    .field span{ color: rgb(var(--muted)); font-size: 13px; }
    .field small{ color: rgb(var(--faint)); font-size: 12px; line-height: 1.5; }

    input, select, textarea{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgb(var(--border) / .55);
      background: rgb(var(--bg) / .55);
      color: rgb(var(--text));
      padding: 12px 12px;
      font: inherit;
      transition: border-color var(--t) var(--ease), background var(--t) var(--ease), box-shadow var(--t) var(--ease);
    }
    textarea{ resize: vertical; min-height: 140px; }
    input:focus, select:focus, textarea:focus{
      outline: none;
      border-color: rgb(var(--accent) / .65);
      box-shadow: 0 0 0 4px rgb(var(--accent) / .12);
      background: rgb(var(--bg) / .70);
    }

    .consent{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      margin-top: 4px;
      margin-bottom: 6px;
      padding: 12px;
      border-radius: var(--r-xl);
      border: 1px solid rgb(var(--border) / .25);
      background: rgb(var(--surface) / .14);
      color: rgb(var(--muted));
      font-size: 12px;
      line-height: 1.6;
    }
    .consent input{ width: 18px; height: 18px; margin-top: 2px; }
    .consent a{ color: rgb(var(--text)); }

    .fine{ margin-top: 10px; font-size: 12px; color: rgb(var(--faint)); }

    .hidden{ display:none; }

    .err{
      min-height: 20px;
      color: rgb(255 120 120);
      font-size: 12px;
      margin-top: 6px;
    }

    @media (min-width: 980px){
      .top-grid{ grid-template-columns: 1.05fr .95fr; align-items: start; }
      .meta{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .grid2{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .form{ padding: 20px; }
    }
  </style>
</BaseLayout>
