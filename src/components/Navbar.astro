---
/** Current request path (no origin), default "/" */
const pathname = Astro.url?.pathname ?? "/";

/** EN lives under /en/... */
const isEn = pathname === "/en" || pathname.startsWith("/en/");

/**
 * Ensure trailing slash for route-like paths (Astro static pages).
 * Keep "/" as-is.
 * Do NOT enforce on file-like paths (e.g. /sitemap.xml).
 * @param {string} p
 * @returns {string}
 */
const ensureTrailingSlash = (p) => {
  if (!p) return "/";
  if (p === "/" || p.endsWith("/")) return p;
  if (/\.[a-z0-9]+$/i.test(p)) return p; // file path
  return `${p}/`;
};

/**
 * Normalize for comparisons (case-insensitive, trailing slash enforced).
 * @param {string} p
 * @returns {string}
 */
const normalizeComparable = (p) => ensureTrailingSlash(p).toLowerCase();

/**
 * Strip leading "/en" for DE path derivation.
 * Examples:
 *  - "/en/services/" -> "/services/"
 *  - "/en/" -> "/"
 * @type {string}
 */
const dePathRaw = isEn ? pathname.replace(/^\/en(?=\/|$)/, "") : pathname;
const dePath = ensureTrailingSlash(dePathRaw || "/");

/**
 * Build EN path from DE path:
 *  - "/" -> "/en/"
 *  - "/services/" -> "/en/services/"
 * @type {string}
 */
const enPath = dePath === "/" ? "/en/" : ensureTrailingSlash(`/en${dePath}`);

/**
 * Language switch base target WITHOUT query.
 * Query/hash will be appended client-side (Astro static output safe).
 */
const langBaseHref = isEn ? dePath : enPath;

/** Base prefix for nav links */
const base = isEn ? "/en" : "";

/** Labels: EN/DE */
const labels = isEn
  ? {
      home: "Home",
      services: "Services",
      shop: "RecVerseShop",
      contact: "Contact",
      cta: "Start a brainstorm",
      lang: "DE",
      langAria: "Switch language to German",
      menu: "Menu",
      close: "Close",
    }
  : {
      home: "Start",
      services: "Leistungen",
      shop: "RecVerseShop",
      contact: "Kontakt",
      cta: "Brainstorming starten",
      lang: "EN",
      langAria: "Switch language to English",
      menu: "Menü",
      close: "Schliessen",
    };

/** Nav structure identical DE/EN; enforce trailing slash in hrefs */
const links = [
  { href: `${base}/`, label: labels.home },
  { href: `${base}/services/`, label: labels.services },
  { href: `${base}/shop/`, label: labels.shop },
  { href: `${base}/contact/`, label: labels.contact },
];

/** Active matching */
const current = normalizeComparable(pathname);
/** @param {string} href */
const isActive = (href) => normalizeComparable(href) === current;
---

<header class="nav-wrap" data-nav>
  <div class="nav container">
    <!-- Brand -->
    <a class="brand" href={isEn ? "/en/" : "/"}>
      <span class="brand-mark" aria-hidden="true"></span>
      <span class="brand-text">Recverse</span>
    </a>

    <!-- Desktop nav -->
    <nav class="nav-links" aria-label="Primary">
      {links.map((l) => (
        <a class={`nav-link ${isActive(l.href) ? "is-active" : ""}`} href={l.href}>
          {l.label}
        </a>
      ))}
    </nav>

    <!-- Right -->
    <div class="nav-right">
      <!-- Language switch (query/hash preserved client-side) -->
      <a
        class="lang"
        href={langBaseHref}
        data-preserve-query
        aria-label={labels.langAria}
        title={labels.langAria}
      >
        {labels.lang}
      </a>

      <!-- CTA (preserve query/hash too, AND keep contact?topic=Brainstorming) -->
      <a
        class="btn btn-primary nav-cta"
        href={`${base}/contact/?topic=Brainstorming`}
        data-preserve-query
        data-merge-query
      >
        {labels.cta}
      </a>

      <!-- Mobile toggle -->
      <button class="burger" type="button" aria-label={labels.menu} aria-expanded="false" data-burger>
        <span></span><span></span><span></span>
      </button>
    </div>
  </div>

  <!-- Mobile panel -->
  <div class="mobile" data-mobile hidden>
    <div class="mobile-inner container">
      <div class="mobile-top">
        <div class="mobile-title">Recverse</div>
        <button class="mobile-close" type="button" aria-label={labels.close} data-close>×</button>
      </div>

      <div class="mobile-actions">
        <a
          class="lang mobile-lang"
          href={langBaseHref}
          data-preserve-query
          aria-label={labels.langAria}
          title={labels.langAria}
        >
          {labels.lang}
        </a>

        <a
          class="btn btn-primary"
          href={`${base}/contact/?topic=Brainstorming`}
          data-preserve-query
          data-merge-query
        >
          {labels.cta}
        </a>
      </div>

      <nav class="mobile-links" aria-label="Mobile Primary">
        {links.map((l) => (
          <a class={`mobile-link ${isActive(l.href) ? "is-active" : ""}`} href={l.href}>
            {l.label}
          </a>
        ))}
      </nav>
    </div>
  </div>
</header>

<script is:inline>
  const header = document.querySelector("[data-nav]");
  const burger = header?.querySelector("[data-burger]");
  const mobile = header?.querySelector("[data-mobile]");
  const closeBtn = header?.querySelector("[data-close]");

  const openMenu = () => {
    if (!mobile || !burger) return;
    mobile.hidden = false;
    burger.setAttribute("aria-expanded", "true");
    document.documentElement.classList.add("nav-open");
  };

  const closeMenu = () => {
    if (!mobile || !burger) return;
    mobile.hidden = true;
    burger.setAttribute("aria-expanded", "false");
    document.documentElement.classList.remove("nav-open");
  };

  burger?.addEventListener("click", () => {
    const expanded = burger.getAttribute("aria-expanded") === "true";
    expanded ? closeMenu() : openMenu();
  });

  closeBtn?.addEventListener("click", closeMenu);

  mobile?.addEventListener("click", (e) => {
    if (e.target === mobile) closeMenu();
  });

  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeMenu();
  });

  header?.querySelectorAll(".mobile-link").forEach((a) => {
    a.addEventListener("click", closeMenu);
  });

  // ==========================================================
  // Preserve Query + Hash (Astro static output safe)
  //
  // Works for:
  // - Language switch (keep ?topic=... / utm_* / any params)
  // - CTA buttons (merge existing target query with current query)
  //
  // Behavior:
  // - data-preserve-query: always carry over current search+hash
  // - data-merge-query: if link already has query (e.g. ?topic=Brainstorming),
  //   merge it with current query; current query wins on conflicts except `topic`
  //   where the link's topic wins (so CTA keeps Brainstorming by design).
  // ==========================================================

  /** Merge two URLSearchParams; optionally protect keys from being overwritten */
  const mergeSearchParams = (baseParams, incomingParams, { protectKeys = [] } = {}) => {
    const protect = new Set(protectKeys.map((k) => String(k).toLowerCase()));
    for (const [k, v] of incomingParams.entries()) {
      const lk = k.toLowerCase();
      if (protect.has(lk) && baseParams.has(k)) continue;
      // If key exists in different casing, overwrite the first match
      // (keep behavior simple: delete all variants then set)
      for (const key of Array.from(baseParams.keys())) {
        if (key.toLowerCase() === lk) baseParams.delete(key);
      }
      baseParams.set(k, v);
    }
    return baseParams;
  };

  const buildPreservedHref = (anchorEl) => {
    const href = anchorEl.getAttribute("href") || "/";
    const u = new URL(href, window.location.origin);

    const currentSearch = new URLSearchParams(window.location.search || "");
    const targetSearch = new URLSearchParams(u.search || "");

    const wantsMerge = anchorEl.hasAttribute("data-merge-query");

    // If merge: keep target query (e.g. topic=Brainstorming) and also bring over current query (utm_*)
    // Conflict policy:
    // - `topic` is protected (CTA keeps its topic)
    // - for everything else current query wins (so utm_* updated, etc.)
    if (wantsMerge) {
      // Start with current query (so it generally wins)...
      const merged = new URLSearchParams(currentSearch.toString());
      // ...then merge target, but protect topic from being overwritten if already present in merged
      // However we want CTA's topic to win vs current: so we instead protect nothing and explicitly enforce topic last.
      // Strategy:
      // 1) merged = current
      // 2) merged <- target (target overwrites)
      // 3) if current had any key not in target, it stays
      mergeSearchParams(merged, targetSearch, { protectKeys: [] });

      // Ensure CTA topic is always the target topic if present
      const targetTopicKey = Array.from(targetSearch.keys()).find((k) => k.toLowerCase() === "topic");
      if (targetTopicKey) {
        const targetTopicVal = targetSearch.get(targetTopicKey);
        // delete any topic variants then set
        for (const key of Array.from(merged.keys())) {
          if (key.toLowerCase() === "topic") merged.delete(key);
        }
        merged.set(targetTopicKey, targetTopicVal);
      }

      u.search = merged.toString() ? `?${merged.toString()}` : "";
    } else {
      // Preserve only current query (overwrite any target query)
      u.search = currentSearch.toString() ? `?${currentSearch.toString()}` : "";
    }

    // Always preserve hash from current location (campaign links should not carry target hash)
    u.hash = window.location.hash || "";

    return u.pathname + u.search + u.hash;
  };

  const applyPreserve = (a) => {
    try {
      a.setAttribute("href", buildPreservedHref(a));
    } catch {
      // no-op
    }
  };

  const preservedLinks = header?.querySelectorAll("a[data-preserve-query]") || [];
  preservedLinks.forEach((a) => {
    // Update immediately so: right-click copy works correctly
    applyPreserve(a);

    // Update on click (in case something changed after initial render)
    a.addEventListener("click", () => applyPreserve(a));
  });
</script>

<style>
  .nav-wrap {
    position: sticky;
    top: 0;
    z-index: 50;
    backdrop-filter: blur(10px);
    background: rgba(5, 7, 12, 0.72);
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  }

  .container {
    width: min(1120px, calc(100% - 32px));
    margin: 0 auto;
  }

  .nav {
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    gap: 14px;
    align-items: center;
    padding: 12px 0;
  }

  .brand {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    text-decoration: none;
    color: inherit;
    min-width: 160px;
  }

  .brand-mark {
    width: 12px;
    height: 12px;
    border-radius: 999px;
    background: var(--accent, #3b82f6);
    box-shadow: 0 0 22px rgba(59, 130, 246, 0.55);
  }

  .brand-text {
    font-family: var(--font-head, "Space Grotesk", system-ui);
    font-weight: 700;
    letter-spacing: 0.2px;
  }

  .nav-links {
    display: none;
    justify-content: center;
    gap: 18px;
  }

  .nav-link {
    text-decoration: none;
    color: rgba(255, 255, 255, 0.78);
    font-size: 14px;
    padding: 8px 10px;
    border-radius: 10px;
    transition: transform 120ms ease, background 120ms ease, color 120ms ease;
  }

  .nav-link:hover {
    background: rgba(255, 255, 255, 0.06);
    color: rgba(255, 255, 255, 0.95);
    transform: translateY(-1px);
  }

  .nav-link.is-active {
    background: rgba(255, 255, 255, 0.08);
    color: rgba(255, 255, 255, 0.98);
  }

  .nav-right {
    display: inline-flex;
    justify-content: flex-end;
    align-items: center;
    gap: 10px;
  }

  .lang {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 38px;
    border-radius: 12px;
    text-decoration: none;
    font-weight: 700;
    letter-spacing: 0.3px;
    color: rgba(255, 255, 255, 0.88);
    border: 1px solid rgba(255, 255, 255, 0.10);
    background: rgba(255, 255, 255, 0.04);
    transition: background 120ms ease, transform 120ms ease;
  }

  .lang:hover {
    background: rgba(255, 255, 255, 0.07);
    transform: translateY(-1px);
  }

  .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 14px;
    padding: 10px 14px;
    font-weight: 700;
    text-decoration: none;
    border: 1px solid rgba(255, 255, 255, 0.10);
    background: rgba(255, 255, 255, 0.06);
    color: rgba(255, 255, 255, 0.92);
    transition: transform 120ms ease, background 120ms ease;
    white-space: nowrap;
  }

  .btn:hover {
    transform: translateY(-1px);
    background: rgba(255, 255, 255, 0.09);
  }

  .btn-primary {
    background: linear-gradient(135deg, rgba(59,130,246,0.95), rgba(34,211,238,0.85));
    border-color: rgba(59,130,246,0.35);
    color: #071018;
  }

  .btn-primary:hover {
    background: linear-gradient(135deg, rgba(59,130,246,1), rgba(34,211,238,0.95));
  }

  .nav-cta { display: none; }

  .burger {
    width: 44px;
    height: 38px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.04);
    display: inline-grid;
    place-content: center;
    gap: 4px;
    padding: 0;
  }

  .burger span {
    width: 18px;
    height: 2px;
    background: rgba(255,255,255,0.85);
    border-radius: 99px;
    display: block;
  }

  .mobile {
    background: rgba(5,7,12,0.55);
    border-top: 1px solid rgba(255, 255, 255, 0.06);
  }

  .mobile-inner { padding: 14px 0 18px; }

  .mobile-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 12px;
  }

  .mobile-title {
    font-family: var(--font-head, "Space Grotesk", system-ui);
    font-weight: 800;
    letter-spacing: 0.2px;
  }

  .mobile-close {
    width: 44px;
    height: 38px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,0.10);
    background: rgba(255,255,255,0.04);
    color: rgba(255,255,255,0.85);
    font-size: 22px;
    line-height: 1;
  }

  .mobile-actions {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
    margin-top: 12px;
  }

  .mobile-links {
    display: grid;
    gap: 10px;
    margin-top: 14px;
  }

  .mobile-link {
    text-decoration: none;
    color: rgba(255,255,255,0.9);
    padding: 12px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(255,255,255,0.03);
  }

  .mobile-link.is-active {
    background: rgba(255,255,255,0.07);
    border-color: rgba(255,255,255,0.14);
  }

  @media (min-width: 920px) {
    .nav-links { display: flex; }
    .nav-cta { display: inline-flex; }
    .burger { display: none; }
    .mobile { display: none; }
  }

  .nav-open { overflow: hidden; }
</style>
